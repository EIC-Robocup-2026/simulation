x-gpu-config:
  &gpu-config
  runtime: nvidia
  environment:
    - USER
    - DISPLAY=${DISPLAY:?err}
    - NVIDIA_VISIBLE_DEVICES=all
    - NVIDIA_DRIVER_CAPABILITIES=all
    - XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR}
    - FASTDDS_BUILTIN_TRANSPORTS=UDPv4
    - RMW_IMPLEMENTATION=rmw_fastrtps_cpp

x-cpu-config:
  &cpu-config
  environment:
    - USER
    - DISPLAY=${DISPLAY:?err}
    - XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR}
    - FASTDDS_BUILTIN_TRANSPORTS=UDPv4
    - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
  devices:
    - /dev/dri

services:
  robot_simulation:
    image: eic-robocup2026-development:latest
    <<: [ *cpu-config]
    container_name: robot-simulation
    network_mode: host
    ipc: host
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ../:/ros2_ws/src
    # command: tail -f /dev/null
    command: >
          bash -c "source /opt/ros/jazzy/setup.bash &&
                   colcon build --symlink-install &&
                   source install/setup.bash &&
                   ros2 launch robot_simulation gzsim_omnibot.launch.py"
